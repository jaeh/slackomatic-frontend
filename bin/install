#!/bin/bash
#move to app root directory
cd /home/pi/nodejs/;
#first install all dependencies
npm install

#remove dist directory
sudo rm -rf dist

#installs a google webfont for local use and serving
./node_modules/.bin/webfont-dl https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700 \
  --font-out=dist/public/font \
  --out public/css/include/font.styl \
  --css-rel=/font

#create dist/bin directory if not exists
mkdir dist/bin  -p
#copy the run bin file to the dist dir
cp bin/run-production dist/bin/run
#make sure dist/bin/run is executable
chmod +x dist/bin/run

#copy node-raspbian install, needed for updates and first install
cp bin/install-node-raspbian dist/bin/install-node-raspbian
#make sure dist/bin/install-node-raspbian is executable
chmod +x dist/bin/install-node-raspbian

#create log directory for node app if not exists
mkdir dist/log -p

#copy package.json to dist for install below
echo 'copying package.json to dist'
cp package.json dist/package.json

#npm install production dependencies in dist
echo 'installing npm production dependencies' 
cd dist && npm install --production && cd ../

#run the build process to finish precompilation of dependencies
./bin/build
